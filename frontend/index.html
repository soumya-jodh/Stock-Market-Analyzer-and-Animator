<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Stock Animator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Stock Market Analyzer & Animator</h1>

    <div class="controls">
      <label>Upload CSV (date,price) or paste JSON</label>
      <input id="csvFile" type="file" accept=".csv" />
      <button id="btnUpload">Upload & Process</button>
    </div>

    <div class="result" id="resultBox" style="display:none;">
      <p id="summary"></p>
      <canvas id="chart" width="800" height="400"></canvas>
    </div>

    <hr />
    <div>
      <!-- <h3>Quick JSON POST example</h3>
      <pre>
{
  "series":[
    {"date":"2025-10-10","price":100},
    {"date":"2025-10-13","price":98},
    {"date":"2025-10-16","price":110}
  ]
} -->
      </pre>
    </div>
  </div>

<script>
const apiUrl = '/api/process_csv'; // same-origin

function animateLine(chart, dataPoints) {
  // draw progressive animation by updating dataset point count
  const total = dataPoints.length;
  let current = 1;
  chart.data.datasets[0].data = dataPoints.slice(0, current);
  chart.update();

  const step = () => {
    current++;
    if (current > total) return;
    chart.data.datasets[0].data = dataPoints.slice(0, current);
    chart.update();
    requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

function drawChart(series, buyIdx, sellIdx) {
  const labels = series.map(p => p.date || "");
  const values = series.map(p => p.price);

  const ctx = document.getElementById('chart').getContext('2d');

  // destroy old chart if present
  if (window._stockChart) {
    window._stockChart.destroy();
  }

  window._stockChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Price',
        data: [], // initially empty for animation
        borderWidth: 2,
        tension: 0.2,
        pointRadius: 3,
        fill: false
      }]
    },
    options: {
      animation: false,
      scales: {
        x: { display: true },
        y: { display: true, beginAtZero: false }
      },
      plugins: {
        tooltip: { enabled: true },
        legend: { display: false }
      }
    }
  });

  // animate drawing
  const dataPoints = values.map(v => ({ x: null, y: v })); // Chart.js accepts numbers as well
  animateLine(window._stockChart, values);

  // after short delay mark buy/sell with custom points & vertical lines
  setTimeout(() => {
    // add markers dataset
    window._stockChart.data.datasets.push({
      label: 'Buy/Sell',
      data: values.map((v,i) => {
        if (i === buyIdx) return v;
        if (i === sellIdx) return v;
        return null;
      }),
      showLine: false,
      pointRadius: values.map((_,i)=> (i===buyIdx||i===sellIdx)?8:0),
      pointStyle: values.map((_,i)=> (i===buyIdx)?'triangle':'rectRot'),
      // colors are left default to Chart.js; not specifying specific colors per requirement
    });
    window._stockChart.update();
  }, 600);
}

async function processFile(file) {
  const form = new FormData();
  form.append('file', file);
  const res = await fetch('/api/process_csv', { method: 'POST', body: form });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Server error');
  return data;
}

async function processSample() {
  // send JSON to /api/process_json for sample
  const sample = {
    series: [
      {"date":"2025-10-10","price":100},
      {"date":"2025-10-13","price":98},
      {"date":"2025-10-14","price":105},
      {"date":"2025-10-15","price":102},
      {"date":"2025-10-16","price":110},
      {"date":"2025-10-17","price":108}
    ]
  };
  const res = await fetch('/api/process_json', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(sample)
  });
  return res.json();
}

document.getElementById('btnUpload').addEventListener('click', async () => {
  const f = document.getElementById('csvFile').files[0];
  if (!f) return alert('Please select a CSV file first.');
  try {
    const data = await processFile(f);
    showResult(data);
  } catch (err) {
    alert('Error: ' + err.message);
  }
});

document.getElementById('btnSample').addEventListener('click', async () => {
  try {
    const data = await processSample();
    if (data.error) throw new Error(data.error);
    showResult(data);
  } catch (err) {
    alert('Error: ' + err.message);
  }
});

function showResult(data) {
  document.getElementById('resultBox').style.display = 'block';
  const buy = data.best_buy;
  const sell = data.best_sell;
  const profit = data.profit;
  const s = data.series;
  const summary = `Buy on ${buy.date} (index ${buy.index}) at ${buy.price} â€” Sell on ${sell.date} (index ${sell.index}) at ${sell.price}. Profit: ${profit}`;
  document.getElementById('summary').innerText = summary;
  drawChart(s, buy.index, sell.index);
}
</script>
</body>
</html>
